{"files":[{"id":"4daa865f-6664-40c6-88c2-33b24b1d906b","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Taipei\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"c249cf25-bce8-475e-ad9f-31548bdde27a","name":"Code","type":"server_js","source":"/**\n * Code.gs\n * Google Apps Script — 狼人殺 (完整版)\n * 儲存：PropertiesService.getScriptProperties().setProperty(\u0027WEREWOLF_ROOMS\u0027, JSON.stringify(roomsObj))\n *\n * 權限：會使用 DriveApp（儲存頭像）\n */\n\nconst CONFIG \u003d {\n  ROOM_KEY: \u0027WEREWOLF_ROOMS\u0027,\n  AVATAR_FOLDER: \u0027Werewolf_Avatars\u0027,\n  POLL_INTERVAL_MS: 1500,\n  DEFAULT_PLAYERS: 6,\n  ROLE_DISTRIBUTION: [\u0027werewolf\u0027,\u0027werewolf\u0027,\u0027seer\u0027,\u0027doctor\u0027,\u0027villager\u0027,\u0027villager\u0027] // for 6 players\n};\n\n// \u003d\u003d\u003d\u003d\u003d\u003d\u003d 基礎工具 \u003d\u003d\u003d\u003d\u003d\u003d\u003d\nfunction _loadRooms(){\n  const p \u003d PropertiesService.getScriptProperties().getProperty(CONFIG.ROOM_KEY);\n  return p ? JSON.parse(p) : {};\n}\nfunction _saveRooms(obj){\n  PropertiesService.getScriptProperties().setProperty(CONFIG.ROOM_KEY, JSON.stringify(obj));\n}\nfunction _now(){ return (new Date()).toISOString(); }\nfunction _uid(prefix){\n  return (prefix||\u0027id_\u0027) + Math.random().toString(36).slice(2,9);\n}\n\n/**\n * 取得或建立 avatar 資料夾\n */\nfunction _getAvatarFolder(){\n  const name \u003d CONFIG.AVATAR_FOLDER;\n  const it \u003d DriveApp.getFoldersByName(name);\n  if(it.hasNext()) return it.next();\n  return DriveApp.createFolder(name);\n}\n\n/* \u003d\u003d\u003d\u003d\u003d Web App entry \u003d\u003d\u003d\u003d\u003d */\nfunction doGet(e){\n  return HtmlService.createTemplateFromFile(\u0027index\u0027).evaluate()\n    .setTitle(\u0027線上狼人殺（Apps Script）\u0027)\n    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 房間 / 玩家 基礎功能 \u003d\u003d\u003d\u003d\u003d */\n\n/**\n * 建立房間（由房主呼叫）\n * hostName: 字串\n * hostAvatarUrl: 可為空字串\n */\nfunction createRoom(hostName, hostAvatarUrl){\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    const rid \u003d \u0027R\u0027 + Math.random().toString(36).slice(2,7).toUpperCase();\n    const hostId \u003d _uid(\u0027P\u0027);\n    rooms[rid] \u003d {\n      id: rid,\n      hostId: hostId,\n      createdAt: _now(),\n      phase: \u0027lobby\u0027, // lobby -\u003e rolesAssigned -\u003e night -\u003e day -\u003e ended\n      round: 0,\n      players: {}, // playerId -\u003e { id, name, avatar, alive, role, joinedAt }\n      chat: [], // {time, system?, name?, text}\n      night: {}, // night actions storage\n      votes: {}  // day votes\n    };\n    rooms[rid].players[hostId] \u003d {\n      id: hostId,\n      name: hostName || \u0027玩家\u0027,\n      avatar: hostAvatarUrl || \u0027\u0027,\n      alive: true,\n      role: null,\n      joinedAt: Date.now()\n    };\n    _saveRooms(rooms);\n    return { roomId: rid, playerId: hostId };\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/**\n * 加入房間\n */\nfunction joinRoom(roomId, name, avatarUrl){\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    if(!rooms[roomId]) return { error: \u0027房間不存在\u0027 };\n    const room \u003d rooms[roomId];\n    const pid \u003d _uid(\u0027P\u0027);\n    room.players[pid] \u003d {\n      id: pid,\n      name: name || \u0027玩家\u0027,\n      avatar: avatarUrl || \u0027\u0027,\n      alive: true,\n      role: null,\n      joinedAt: Date.now()\n    };\n    room.chat.push({ time: _now(), system: true, text: `${name} 已加入房間` });\n    _saveRooms(rooms);\n    return { playerId: pid, room: _stripForClient(room) };\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/**\n * 離開房間（將 player 設為 offline；或完全移除）\n */\nfunction leaveRoom(roomId, playerId){\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    if(!rooms[roomId]) return;\n    const room \u003d rooms[roomId];\n    if(room.players \u0026\u0026 room.players[playerId]){\n      // 我們把玩家移除（若要只是標記 offline 可改）\n      const name \u003d room.players[playerId].name;\n      delete room.players[playerId];\n      room.chat.push({ time:_now(), system:true, text: `${name} 離開房間` });\n      _saveRooms(rooms);\n    }\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 上傳頭像（前端傳 DataURL） \u003d\u003d\u003d\u003d\u003d\n   傳入 base64 DataURL 字串與檔名，回傳公開檔案 URL（Drive）\n*/\nfunction uploadAvatar(dataUrl, filename){\n  if(!dataUrl) return \u0027\u0027;\n  const matches \u003d dataUrl.match(/^data:(.+);base64,(.+)$/);\n  if(!matches) return \u0027\u0027;\n  const contentType \u003d matches[1];\n  const base64 \u003d matches[2];\n  const bytes \u003d Utilities.base64Decode(base64);\n  const folder \u003d _getAvatarFolder();\n  const cleanName \u003d (filename || \u0027avatar\u0027) + \u0027_\u0027 + Math.floor(Math.random()*10000);\n  const blob \u003d Utilities.newBlob(bytes, contentType, cleanName);\n  const file \u003d folder.createFile(blob);\n  // 設為 anyone with link 可讀\n  try{\n    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);\n  }catch(e){\n    // 若沒有權限，忽略（通常會有）\n  }\n  return file.getDownloadUrl ? file.getDownloadUrl() : file.getUrl();\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 取房間狀態（供前端輪詢） \u003d\u003d\u003d\u003d\u003d */\nfunction getRoomState(roomId, requesterId){\n  const rooms \u003d _loadRooms();\n  if(!rooms[roomId]) return { error: \u0027房間不存在\u0027 };\n  const room \u003d rooms[roomId];\n  // 回傳對 client 安全且必要的資料（不要把所有角色公開給所有人）\n  return _stripForClient(room, requesterId);\n}\n\n/**\n * 把房間資料過濾成可以給前端的安全格式\n * requesterId: 若非房主或未被允許，某些欄位會被遮蔽（例如其他人的 role）\n */\nfunction _stripForClient(room, requesterId){\n  const r \u003d {\n    id: room.id,\n    hostId: room.hostId,\n    phase: room.phase,\n    round: room.round,\n    chat: room.chat || [],\n    players: {},\n    votes: room.votes || {}\n  };\n\n  Object.values(room.players || {}).forEach(p\u003d\u003e{\n    let showRole \u003d false;\n\n    if(room.phase \u003d\u003d\u003d \u0027ended\u0027){\n      // 遊戲結束，公開所有角色\n      showRole \u003d true;\n    } else if(p.id \u003d\u003d\u003d requesterId){\n      // 永遠可以看到自己的角色\n      showRole \u003d true;\n    }\n    // 房主不能看到其他人角色，除非遊戲結束\n    // 其他玩家也不能看到別人角色，除非遊戲結束\n    r.players[p.id] \u003d {\n      id: p.id,\n      name: p.name,\n      avatar: p.avatar || \u0027\u0027,\n      alive: !!p.alive,\n      role: showRole ? p.role : null\n    };\n  });\n\n  // 預言家夜晚查看結果仍可單獨看到\n  if(requesterId \u0026\u0026 room.night \u0026\u0026 room.night.checks \u0026\u0026 room.night.checks[requesterId]){\n    r.myCheck \u003d room.night.checks[requesterId]; // {targetId, role}\n  }\n\n  return r;\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 分配身分（房主） \u003d\u003d\u003d\u003d\u003d */\nfunction assignRoles(roomId, callerId){\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    if(!rooms[roomId]) return { error:\u0027房間不存在\u0027 };\n    const room \u003d rooms[roomId];\n    if(room.hostId !\u003d\u003d callerId) return { error:\u0027只有房主能分配身分\u0027 };\n    const players \u003d Object.values(room.players || {});\n    const n \u003d players.length;\n    if(n \u003c 4) return { error:\u0027玩家不足（至少 4 人）\u0027 };\n    // 準備身分：若玩家數等於 CONFIG.DEFAULT_PLAYERS，使用 ROLE_DISTRIBUTION，否則自動生成（簡單規則）\n    let roles \u003d [];\n    if(n \u003d\u003d\u003d CONFIG.DEFAULT_PLAYERS) roles \u003d CONFIG.ROLE_DISTRIBUTION.slice();\n    else {\n      // 1狼人 per 3 players (rough), 保證至少1狼人、1預言家、1守衛\n      let wolves \u003d Math.max(1, Math.floor(n/3));\n      roles \u003d [];\n      for(let i\u003d0;i\u003cwolves;i++) roles.push(\u0027werewolf\u0027);\n      roles.push(\u0027seer\u0027); roles.push(\u0027doctor\u0027);\n      while(roles.length \u003c n) roles.push(\u0027villager\u0027);\n    }\n    // shuffle and assign\n    roles \u003d _shuffle(roles);\n    const shuffledPlayers \u003d _shuffle(players.map(p\u003d\u003ep.id));\n    shuffledPlayers.forEach((pid, i)\u003d\u003e{\n      room.players[pid].role \u003d roles[i];\n      room.players[pid].alive \u003d true;\n    });\n    room.phase \u003d \u0027rolesAssigned\u0027;\n    room.round \u003d 0;\n    room.night \u003d { kills: {}, saves: {}, checks: {} };\n    room.chat.push({ time:_now(), system:true, text:\u0027房主分配了身分\u0027 });\n    _saveRooms(rooms);\n    return { ok:true };\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 夜晚操作（玩家 client 呼叫） \u003d\u003d\u003d\u003d\u003d\n   - werewolf 可 submit kill: night.kills[playerId]\u003dtargetId\n   - seer 可 submit check: night.checks[playerId]\u003d{targetId, role}\n   - doctor 可 submit save: night.saves[playerId]\u003dtargetId\n*/\nfunction submitNightAction(roomId, playerId, action){\n  /**\n   * action \u003d { type: \u0027kill\u0027|\u0027check\u0027|\u0027save\u0027, targetId: \u0027Pxxxx\u0027 }\n   */\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    if(!rooms[roomId]) return { error:\u0027room not found\u0027 };\n    const room \u003d rooms[roomId];\n    const p \u003d room.players[playerId];\n    if(!p || !p.alive) return { error:\u0027player invalid\u0027 };\n    if(action.type \u003d\u003d\u003d \u0027kill\u0027 \u0026\u0026 p.role \u003d\u003d\u003d \u0027werewolf\u0027){\n      room.night.kills \u003d room.night.kills || {};\n      room.night.kills[playerId] \u003d action.targetId;\n      room.chat.push({ time:_now(), system:true, text: `（狼人） 已選擇目標` });\n    } else if(action.type \u003d\u003d\u003d \u0027check\u0027 \u0026\u0026 p.role \u003d\u003d\u003d \u0027seer\u0027){\n      room.night.checks \u003d room.night.checks || {};\n      const t \u003d room.players[action.targetId];\n      room.night.checks[playerId] \u003d { targetId: action.targetId, role: t? t.role : null };\n      room.chat.push({ time:_now(), system:true, text: `（預言家） 已查看某位玩家` });\n    } else if(action.type \u003d\u003d\u003d \u0027save\u0027 \u0026\u0026 p.role \u003d\u003d\u003d \u0027doctor\u0027){\n      room.night.saves \u003d room.night.saves || {};\n      room.night.saves[playerId] \u003d action.targetId;\n      room.chat.push({ time:_now(), system:true, text: `（守衛） 已選擇保護` });\n    } else {\n      return { error:\u0027action not permitted\u0027 };\n    }\n    _saveRooms(rooms);\n    return { ok:true };\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 房主執行：結束夜晚並計算結果 \u003d\u003d\u003d\u003d\u003d */\nfunction resolveNight(roomId, callerId){\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    const room \u003d rooms[roomId];\n    if(!room) return { error:\u0027room not found\u0027 };\n    if(room.hostId !\u003d\u003d callerId) return { error:\u0027only host can resolve night\u0027 };\n    // 判斷 kill: 多個狼人可能有多個選擇，這裡簡化成：統計被選最多的 target\n    const kills \u003d room.night.kills || {};\n    const saves \u003d room.night.saves || {};\n    const checks \u003d room.night.checks || {};\n    const tally \u003d {};\n    Object.values(kills).forEach(tid\u003d\u003e{ tally[tid] \u003d (tally[tid]||0)+1; });\n    let targetId \u003d null;\n    if(Object.keys(tally).length\u003e0){\n      // pick max voters\n      targetId \u003d Object.entries(tally).sort((a,b)\u003d\u003eb[1]-a[1])[0][0];\n    }\n    // 決定是否被守衛救下（若有多個守衛選擇，任何一個救下都有效）\n    let saved \u003d false;\n    if(targetId){\n      const saveTargets \u003d Object.values(saves || {});\n      if(saveTargets.indexOf(targetId) !\u003d\u003d -1) saved \u003d true;\n    }\n    let killedName \u003d null;\n    if(targetId \u0026\u0026 !saved){\n      if(room.players[targetId]){\n        room.players[targetId].alive \u003d false;\n        killedName \u003d room.players[targetId].name;\n        room.chat.push({ time:_now(), system:true, text: `夜晚結果：${killedName} 遭到攻擊並死亡` });\n      }\n    } else {\n      if(targetId \u0026\u0026 saved){\n        room.chat.push({ time:_now(), system:true, text: `夜晚結果：有人遭到攻擊，但被守衛救下` });\n      } else {\n        room.chat.push({ time:_now(), system:true, text: `夜晚結果：沒有攻擊發生` });\n      }\n    }\n    // 把預言家的查看結果放在 room.night.reports 以供其查看\n    room.night.reports \u003d room.night.reports || {};\n    Object.entries(checks || {}).forEach(([seerId,info])\u003d\u003e{\n      room.night.reports[seerId] \u003d info; // store {targetId, role}\n    });\n    // 清空夜晚行動（或保留歷史視需求）\n    room.night.kills \u003d {}; room.night.saves \u003d {}; room.night.checks \u003d {};\n    // 進入白天\n    room.phase \u003d \u0027day\u0027;\n    room.round \u003d (room.round || 0) + 1;\n    room.votes \u003d {}; // reset votes\n    // 檢查勝利\n    _evaluateWin(room);\n    _saveRooms(rooms);\n    return { ok:true, killed: killedName || null };\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 白天投票：每位玩家呼叫 submitVote() 寫入自己的投票 \u003d\u003d\u003d\u003d\u003d */\nfunction submitVote(roomId, voterId, targetId){\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    const room \u003d rooms[roomId];\n    if(!room) return { error:\u0027room not found\u0027 };\n    room.votes \u003d room.votes || {};\n    room.votes[voterId] \u003d targetId;\n    _saveRooms(rooms);\n    return { ok:true };\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 房主計算投票結果並執行處決 \u003d\u003d\u003d\u003d\u003d */\nfunction resolveVotes(roomId, callerId){\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    const room \u003d rooms[roomId];\n    if(!room) return { error:\u0027room not found\u0027 };\n    if(room.hostId !\u003d\u003d callerId) return { error:\u0027only host can resolve votes\u0027 };\n    const votes \u003d room.votes || {};\n    const tally \u003d {};\n    Object.values(votes).forEach(tgt\u003d\u003e{ if(tgt) tally[tgt] \u003d (tally[tgt]||0) + 1; });\n    if(Object.keys(tally).length \u003d\u003d\u003d 0){\n      room.chat.push({ time:_now(), system:true, text: \u0027投票無效：沒有人被投票\u0027 });\n    } else {\n      const victimId \u003d Object.entries(tally).sort((a,b)\u003d\u003eb[1]-a[1])[0][0];\n      if(room.players[victimId]){\n        room.players[victimId].alive \u003d false;\n        room.chat.push({ time:_now(), system:true, text: `投票結果：${room.players[victimId].name} 被處決` });\n      }\n    }\n    room.votes \u003d {};\n    // 回到夜晚（除非遊戲結束）\n    _evaluateWin(room);\n    if(room.phase !\u003d\u003d \u0027ended\u0027) room.phase \u003d \u0027night\u0027;\n    _saveRooms(rooms);\n    return { ok:true };\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 勝利判定（簡單版） \u003d\u003d\u003d\u003d\u003d */\nfunction _evaluateWin(room){\n  const players \u003d Object.values(room.players || {});\n  const wolvesAlive \u003d players.filter(p\u003d\u003ep.alive \u0026\u0026 p.role \u003d\u003d\u003d \u0027werewolf\u0027).length;\n  const othersAlive \u003d players.filter(p\u003d\u003ep.alive \u0026\u0026 p.role !\u003d\u003d \u0027werewolf\u0027).length;\n  if(wolvesAlive \u003d\u003d\u003d 0){\n    room.phase \u003d \u0027ended\u0027;\n    room.winner \u003d \u0027villagers\u0027;\n    room.chat.push({ time:_now(), system:true, text: \u0027遊戲結束：村民勝利\u0027 });\n  } else if(wolvesAlive \u003e\u003d othersAlive){\n    room.phase \u003d \u0027ended\u0027;\n    room.winner \u003d \u0027werewolves\u0027;\n    room.chat.push({ time:_now(), system:true, text: \u0027遊戲結束：狼人勝利\u0027 });\n  }\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 聊天（push message 至房間 chat） \u003d\u003d\u003d\u003d\u003d */\nfunction postChat(roomId, playerId, text){\n  const lock \u003d LockService.getScriptLock();\n  lock.waitLock(30000);\n  try{\n    const rooms \u003d _loadRooms();\n    if(!rooms[roomId]) return { error:\u0027room not found\u0027 };\n    const room \u003d rooms[roomId];\n    const name \u003d room.players[playerId] ? room.players[playerId].name : \u0027匿名\u0027;\n    room.chat.push({ time:_now(), name: name, text: text });\n    _saveRooms(rooms);\n    return { ok:true };\n  } finally {\n    lock.releaseLock();\n  }\n}\n\n/* \u003d\u003d\u003d\u003d\u003d 工具：洗牌 \u003d\u003d\u003d\u003d\u003d */\nfunction _shuffle(arr){\n  for(let i\u003darr.length-1;i\u003e0;i--){ const j\u003dMath.floor(Math.random()*(i+1)); [arr[i],arr[j]]\u003d[arr[j],arr[i]]; }\n  return arr;\n}\n"},{"id":"8ea27545-62ef-4b49-ac27-a6a9d2938451","name":"index","type":"html","source":"\u003c!-- index.html --\u003e\n\u003c!doctype html\u003e\n\u003chtml lang\u003d\"zh-Hant\"\u003e\n\u003chead\u003e\n  \u003cmeta charset\u003d\"utf-8\" /\u003e\n  \u003cmeta name\u003d\"viewport\" content\u003d\"width\u003ddevice-width,initial-scale\u003d1\" /\u003e\n  \u003ctitle\u003e線上狼人殺（Apps Script）\u003c/title\u003e\n  \u003c?!\u003d HtmlService.createHtmlOutputFromFile(\u0027style\u0027).getContent(); ?\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n  \u003cdiv class\u003d\"wrap\"\u003e\n    \u003cheader\u003e\n      \u003ch1\u003e線上狼人殺（Apps Script 版）\u003c/h1\u003e\n      \u003cp class\u003d\"small\"\u003e小型多人遊戲，使用 Drive 儲存頭像與 Properties 儲存房間狀態（Demo）\u003c/p\u003e\n    \u003c/header\u003e\n\n    \u003csection id\u003d\"lobby\" class\u003d\"panel\"\u003e\n      \u003cdiv class\u003d\"flex\"\u003e\n        \u003cinput id\u003d\"name\" placeholder\u003d\"輸入你的名字\" /\u003e\n        \u003cinput id\u003d\"avatarFile\" type\u003d\"file\" accept\u003d\"image/*\" /\u003e\n        \u003cbutton id\u003d\"createBtn\" class\u003d\"btn\"\u003e建立房間\u003c/button\u003e\n        \u003cinput id\u003d\"roomInput\" placeholder\u003d\"房間 ID（加入用）\" /\u003e\n        \u003cbutton id\u003d\"joinBtn\" class\u003d\"btn\"\u003e加入房間\u003c/button\u003e\n      \u003c/div\u003e\n      \u003cdiv class\u003d\"small\"\u003e建立房間會成為房主。房主負責分配身分、計算夜晚/投票結果。\u003c/div\u003e\n    \u003c/section\u003e\n\n    \u003csection id\u003d\"roomPanel\" class\u003d\"panel\" style\u003d\"display:none\"\u003e\n      \u003cdiv class\u003d\"flex\" style\u003d\"justify-content:space-between;\"\u003e\n        \u003cdiv\u003e\u003cb\u003e房間：\u003c/b\u003e\u003cspan id\u003d\"roomLabel\"\u003e-\u003c/span\u003e\u003c/div\u003e\n        \u003cdiv class\u003d\"flex\"\u003e\n          \u003cbutton id\u003d\"assignBtn\" class\u003d\"btn\"\u003e分配身分\u003c/button\u003e\n          \u003cbutton id\u003d\"resolveNightBtn\" class\u003d\"btn\"\u003e房主：執行夜晚結果\u003c/button\u003e\n          \u003cbutton id\u003d\"resolveVotesBtn\" class\u003d\"btn\"\u003e房主：計算投票\u003c/button\u003e\n          \u003cbutton id\u003d\"leaveBtn\" class\u003d\"btn warn\"\u003e離開房間\u003c/button\u003e\n        \u003c/div\u003e\n      \u003c/div\u003e\n\n      \u003cdiv style\u003d\"margin-top:12px\" class\u003d\"flex\"\u003e\n        \u003cdiv style\u003d\"flex:1\"\u003e\n          \u003ch3\u003e玩家\u003c/h3\u003e\n          \u003cdiv id\u003d\"players\" class\u003d\"players\"\u003e\u003c/div\u003e\n        \u003c/div\u003e\n\n        \u003cdiv style\u003d\"width:320px;\"\u003e\n          \u003ch3\u003e聊天室\u003c/h3\u003e\n          \u003cdiv id\u003d\"chatBox\" class\u003d\"chatBox\"\u003e\u003c/div\u003e\n          \u003cdiv class\u003d\"flex\" style\u003d\"margin-top:8px\"\u003e\n            \u003cinput id\u003d\"chatInput\" placeholder\u003d\"聊天...\" style\u003d\"flex:1\" /\u003e\n            \u003cbutton id\u003d\"sendChatBtn\" class\u003d\"btn\"\u003e送出\u003c/button\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n      \u003c/div\u003e\n\n      \u003cdiv style\u003d\"margin-top:12px;\"\u003e\n        \u003ch3\u003e遊戲狀態\u003c/h3\u003e\n        \u003cdiv id\u003d\"gameState\" class\u003d\"small\"\u003e-\u003c/div\u003e\n        \u003cdiv id\u003d\"actionArea\"\u003e\u003c/div\u003e\n      \u003c/div\u003e\n    \u003c/section\u003e\n\n  \u003c/div\u003e\n\n  \u003c?!\u003d HtmlService.createHtmlOutputFromFile(\u0027script\u0027).getContent(); ?\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},{"id":"c85d803f-83bf-456e-9811-8b0bf0bdc0dd","name":"script","type":"html","source":"\u003cscript\u003e\n/* 前端互動與 Polling（輪詢） */\nconst POLL_INTERVAL \u003d 1500; // ms\n\nlet state \u003d {\n  roomId: null,\n  playerId: null,\n  name: null,\n  avatarUrl: null,\n  isHost: false\n};\n\n/* 元素 */\nconst nameEl \u003d document.getElementById(\u0027name\u0027);\nconst avatarFileEl \u003d document.getElementById(\u0027avatarFile\u0027);\nconst createBtn \u003d document.getElementById(\u0027createBtn\u0027);\nconst joinBtn \u003d document.getElementById(\u0027joinBtn\u0027);\nconst roomInput \u003d document.getElementById(\u0027roomInput\u0027);\n\nconst roomPanel \u003d document.getElementById(\u0027roomPanel\u0027);\nconst roomLabel \u003d document.getElementById(\u0027roomLabel\u0027);\nconst playersWrap \u003d document.getElementById(\u0027players\u0027);\nconst chatBox \u003d document.getElementById(\u0027chatBox\u0027);\nconst chatInput \u003d document.getElementById(\u0027chatInput\u0027);\nconst sendChatBtn \u003d document.getElementById(\u0027sendChatBtn\u0027);\nconst assignBtn \u003d document.getElementById(\u0027assignBtn\u0027);\nconst resolveNightBtn \u003d document.getElementById(\u0027resolveNightBtn\u0027);\nconst resolveVotesBtn \u003d document.getElementById(\u0027resolveVotesBtn\u0027);\nconst leaveBtn \u003d document.getElementById(\u0027leaveBtn\u0027);\nconst gameStateEl \u003d document.getElementById(\u0027gameState\u0027);\nconst actionArea \u003d document.getElementById(\u0027actionArea\u0027);\n\n/* 事件 */\ncreateBtn.addEventListener(\u0027click\u0027, async ()\u003d\u003e{\n  const name \u003d (nameEl.value || \u0027\u0027).trim() || \u0027玩家\u0027;\n  const avatarBase64 \u003d await _readAvatar();\n  createBtn.disabled \u003d true;\n  google.script.run.withSuccessHandler(res\u003d\u003e{\n    createBtn.disabled \u003d false;\n    if(res \u0026\u0026 res.roomId){\n      state.roomId \u003d res.roomId;\n      state.playerId \u003d res.playerId;\n      state.name \u003d name;\n      state.isHost \u003d true;\n      _enterRoomUI();\n      _startPolling();\n    } else {\n      alert(\u0027建立房間失敗\u0027);\n    }\n  }).createRoom(name, avatarBase64);\n});\n\njoinBtn.addEventListener(\u0027click\u0027, async ()\u003d\u003e{\n  const rid \u003d (roomInput.value||\u0027\u0027).trim();\n  if(!rid){ alert(\u0027請輸入房間 ID\u0027); return; }\n  const name \u003d (nameEl.value || \u0027\u0027).trim() || \u0027玩家\u0027;\n  const avatarBase64 \u003d await _readAvatar();\n  joinBtn.disabled \u003d true;\n  google.script.run.withSuccessHandler(res\u003d\u003e{\n    joinBtn.disabled \u003d false;\n    if(res \u0026\u0026 res.error){ alert(res.error); return; }\n    state.roomId \u003d rid;\n    state.playerId \u003d res.playerId;\n    state.name \u003d name;\n    state.isHost \u003d false;\n    _enterRoomUI();\n    _startPolling();\n  }).joinRoom(rid, name, avatarBase64);\n});\n\nsendChatBtn.addEventListener(\u0027click\u0027, ()\u003d\u003e{\n  const txt \u003d (chatInput.value||\u0027\u0027).trim();\n  if(!txt) return;\n  google.script.run.withSuccessHandler(()\u003d\u003e{ chatInput.value\u003d\u0027\u0027; }).postChat(state.roomId, state.playerId, txt);\n});\n\n/* 房主操作 */\nassignBtn.addEventListener(\u0027click\u0027, ()\u003d\u003e{\n  if(!state.isHost) return alert(\u0027只有房主可分配身分\u0027);\n  assignBtn.disabled \u003d true;\n  google.script.run.withSuccessHandler(res\u003d\u003e{\n    assignBtn.disabled \u003d false;\n    if(res \u0026\u0026 res.error) alert(res.error);\n  }).assignRoles(state.roomId, state.playerId);\n});\nresolveNightBtn.addEventListener(\u0027click\u0027, ()\u003d\u003e{\n  if(!state.isHost) return alert(\u0027只有房主可執行夜晚結果\u0027);\n  resolveNightBtn.disabled \u003d true;\n  google.script.run.withSuccessHandler(res\u003d\u003e{\n    resolveNightBtn.disabled \u003d false;\n  }).resolveNight(state.roomId, state.playerId);\n});\nresolveVotesBtn.addEventListener(\u0027click\u0027, ()\u003d\u003e{\n  if(!state.isHost) return alert(\u0027只有房主可計算投票\u0027);\n  resolveVotesBtn.disabled \u003d true;\n  google.script.run.withSuccessHandler(res\u003d\u003e{\n    resolveVotesBtn.disabled \u003d false;\n  }).resolveVotes(state.roomId, state.playerId);\n});\nleaveBtn.addEventListener(\u0027click\u0027, ()\u003d\u003e{\n  if(!state.roomId || !state.playerId) return;\n  google.script.run.withSuccessHandler(()\u003d\u003e{ location.reload(); }).leaveRoom(state.roomId, state.playerId);\n});\n\n/* 讀取 avatar（DataURL） */\nfunction _readAvatar(){\n  return new Promise((resolve)\u003d\u003e{\n    const f \u003d avatarFileEl.files \u0026\u0026 avatarFileEl.files[0];\n    if(!f) return resolve(\u0027\u0027);\n    const r \u003d new FileReader();\n    r.onload \u003d ()\u003d\u003e resolve(r.result);\n    r.readAsDataURL(f);\n  });\n}\n\n/* 進入房間 UI */\nfunction _enterRoomUI(){\n  document.getElementById(\u0027lobby\u0027).style.display \u003d \u0027none\u0027;\n  roomPanel.style.display \u003d \u0027\u0027;\n  roomLabel.textContent \u003d state.roomId;\n}\n\n/* Polling */\nlet pollingHandle \u003d null;\nfunction _startPolling(){\n  if(pollingHandle) return;\n  _pollOnce();\n  pollingHandle \u003d setInterval(_pollOnce, POLL_INTERVAL);\n}\nfunction _pollOnce(){\n  if(!state.roomId) return;\n  google.script.run.withSuccessHandler(renderRoom).getRoomState(state.roomId, state.playerId);\n}\n\n/* render room state */\nfunction renderRoom(room){\n  if(!room || room.error){ gameStateEl.textContent \u003d room \u0026\u0026 room.error ? room.error : \u0027房間不存在\u0027; return; }\n  // players\n  playersWrap.innerHTML \u003d \u0027\u0027;\n  Object.values(room.players || {}).forEach(p\u003d\u003e{\n    const div \u003d document.createElement(\u0027div\u0027); div.className\u003d\u0027player\u0027;\n    div.innerHTML \u003d `\u003cimg class\u003d\"avatar\" src\u003d\"${p.avatar || \u0027https://via.placeholder.com/64?text\u003d?\u0027}\" /\u003e\n                     \u003cdiv\u003e\u003cb\u003e${p.name}\u003c/b\u003e\u003c/div\u003e\n                     \u003cdiv class\u003d\"small\"\u003e${p.alive ? \u0027\u0027 : \u0027已出局\u0027}\u003c/div\u003e\n                     \u003cdiv class\u003d\"small\"\u003e角色：${p.role ? p.role : (p.id\u003d\u003d\u003dstate.playerId ? \u0027你\u0027 : (room.phase\u003d\u003d\u003d\u0027rolesAssigned\u0027 ? \u0027已分配\u0027 : \u0027-\u0027))}\u003c/div\u003e`;\n    playersWrap.appendChild(div);\n  });\n  // chat\n  chatBox.innerHTML \u003d \u0027\u0027;\n  (room.chat || []).forEach(m\u003d\u003e{\n    const el \u003d document.createElement(\u0027div\u0027);\n    if(m.system) el.innerHTML \u003d `\u003csmall class\u003d\"small\"\u003e${new Date(m.time).toLocaleTimeString()}\u003c/small\u003e ${m.text}`;\n    else el.innerHTML \u003d `\u003csmall class\u003d\"small\"\u003e${new Date(m.time).toLocaleTimeString()}\u003c/small\u003e \u003cb\u003e${m.name}:\u003c/b\u003e ${m.text}`;\n    chatBox.appendChild(el);\n  });\n  chatBox.scrollTop \u003d chatBox.scrollHeight;\n  // game state\n  gameStateEl.textContent \u003d `Phase: ${room.phase} • Round: ${room.round || 0}`;\n  // action area: 根據 phase 與我的 role 顯示可做的操作\n  actionArea.innerHTML \u003d \u0027\u0027;\n  if(room.phase \u003d\u003d\u003d \u0027rolesAssigned\u0027){\n    actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e等待房主開始夜晚（或房主點執行）\u003c/div\u003e\u0027;\n  } else if(room.phase \u003d\u003d\u003d \u0027night\u0027){\n    // 顯示我的夜晚操作（若我還活著）\n    const me \u003d room.players[state.playerId];\n    if(me \u0026\u0026 me.alive){\n      if(me.role \u003d\u003d\u003d \u0027werewolf\u0027){\n        actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e狼人：選擇要攻擊的目標\u003c/div\u003e\u0027;\n        _renderTargetList(room, \u0027kill\u0027);\n      } else if(me.role \u003d\u003d\u003d \u0027seer\u0027){\n        actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e預言家：選擇一位查看身分（不能看自己）\u003c/div\u003e\u0027;\n        _renderTargetList(room, \u0027check\u0027);\n      } else if(me.role \u003d\u003d\u003d \u0027doctor\u0027){\n        actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e守衛：選擇要保護的玩家（可以保護自己）\u003c/div\u003e\u0027;\n        _renderTargetList(room, \u0027save\u0027);\n      } else {\n        actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e夜晚：請等待特殊身分行動\u003c/div\u003e\u0027;\n      }\n    } else {\n      actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e你已陣亡或未加入，等待夜晚結束\u003c/div\u003e\u0027;\n    }\n    // 若我是房主，顯示執行夜晚按鈕（已在 header）\n  } else if(room.phase \u003d\u003d\u003d \u0027day\u0027){\n    actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e白天：討論並投票處決嫌疑人\u003c/div\u003e\u0027;\n    _renderVoteList(room);\n  } else if(room.phase \u003d\u003d\u003d \u0027ended\u0027){\n    actionArea.innerHTML \u003d `\u003cdiv class\u003d\"small\"\u003e遊戲結束。勝利：${room.winner || \u0027 - \u0027}\u003c/div\u003e`;\n  } else {\n    actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e等待玩家加入或房主分配身分\u003c/div\u003e\u0027;\n  }\n\n  // 如果房主，顯示管理按鈕（UI 由 header button 顯示）\n}\n\n/* render target list for actions */\nfunction _renderTargetList(room, actionType){\n  const list \u003d document.createElement(\u0027div\u0027); list.className\u003d\u0027players\u0027;\n  Object.values(room.players || {}).forEach(p\u003d\u003e{\n    if(!p.alive) return;\n    if(actionType\u003d\u003d\u003d\u0027check\u0027 \u0026\u0026 p.id \u003d\u003d\u003d state.playerId) return; // seer 不能看自己\n    const btn \u003d document.createElement(\u0027div\u0027); btn.className\u003d\u0027player\u0027;\n    btn.innerHTML \u003d `\u003cdiv\u003e${p.name}\u003c/div\u003e`;\n    btn.onclick \u003d ()\u003d\u003e{\n      const confirmMsg \u003d (actionType\u003d\u003d\u003d\u0027kill\u0027 ? `確定要選擇攻擊 ${p.name}？` : (actionType\u003d\u003d\u003d\u0027check\u0027 ? `確定查看 ${p.name} 身分？` : `確定保護 ${p.name}？`));\n      if(!confirm(confirmMsg)) return;\n      // call submitNightAction\n      google.script.run.withSuccessHandler(()\u003d\u003e{ /* no-op */ }).submitNightAction(state.roomId, state.playerId, { type: actionType \u003d\u003d\u003d \u0027kill\u0027 ? \u0027kill\u0027 : (actionType\u003d\u003d\u003d\u0027check\u0027 ? \u0027check\u0027 : \u0027save\u0027), targetId: p.id });\n      actionArea.innerHTML \u003d \u0027\u003cdiv class\u003d\"small\"\u003e已發出操作，等待夜晚結算\u003c/div\u003e\u0027;\n    };\n    list.appendChild(btn);\n  });\n  actionArea.appendChild(list);\n}\n\n/* render voting list (day) */\nfunction _renderVoteList(room){\n  const list \u003d document.createElement(\u0027div\u0027); list.className\u003d\u0027players\u0027;\n  Object.values(room.players || {}).forEach(p\u003d\u003e{\n    if(!p.alive) return;\n    const btn \u003d document.createElement(\u0027div\u0027); btn.className\u003d\u0027player\u0027;\n    btn.innerHTML \u003d `\u003cdiv\u003e${p.name}\u003c/div\u003e`;\n    btn.onclick \u003d ()\u003d\u003e{\n      if(!confirm(`確定投票處決 ${p.name} 嗎？`)) return;\n      google.script.run.withSuccessHandler(()\u003d\u003e{ /* ok */ }).submitVote(state.roomId, state.playerId, p.id);\n    };\n    list.appendChild(btn);\n  });\n  actionArea.appendChild(list);\n}\n\u003c/script\u003e\n"},{"id":"1e8ba653-79c6-457d-a0fd-216a66c92477","name":"style","type":"html","source":"\u003cstyle\u003e\nbody{font-family:\"Noto Sans TC\",sans-serif;margin:0;background:#071022;color:#E6EEF8}\n.wrap{max-width:1100px;margin:18px auto;padding:12px}\nh1{margin:0}\n.panel{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;margin-top:12px}\n.flex{display:flex;gap:8px;align-items:center}\ninput,button{padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06)}\n.btn{background:#2563eb;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}\n.btn.warn{background:#dc2626}\n.players{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}\n.player{width:140px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center}\nimg.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;display:block;margin:6px auto}\n.small{font-size:12px;color:#9aa7bf}\n.chatBox{height:260px;overflow:auto;background:rgba(0,0,0,0.25);padding:8px;border-radius:6px}\n#actionArea{margin-top:8px}\n\u003c/style\u003e\n"}]}